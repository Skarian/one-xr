name: Android Build and Maven Publish

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build:
    name: Build App and Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v5

      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build, test, and lint
        run: |
          ./gradlew --warning-mode all \
            :oneproimu:testDebugUnitTest \
            :oneproimu:lintDebug \
            :app:assembleDebug \
            :app:lintDebug \
            :oneproimu:assembleRelease \
            :app:assembleRelease

      - name: Upload demo APK
        uses: actions/upload-artifact@v4
        with:
          name: one-pro-imu-demo-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error

  publish_maven:
    name: Publish Maven Artifact
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v5

      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Compute publish version
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          PUBLISH_VERSION="0.1.0-${SHORT_SHA}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "PUBLISH_VERSION=${PUBLISH_VERSION}" >> "$GITHUB_ENV"
          echo "Using publish version: ${PUBLISH_VERSION}"

      - name: Publish oneproimu to GitHub Packages
        run: |
          ./gradlew \
            :oneproimu:publishReleasePublicationToGitHubPackagesRepository \
            -PPUBLISH_VERSION="${PUBLISH_VERSION}" \
            -PGITHUB_PACKAGES_REPOSITORY="${GITHUB_REPOSITORY}"
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
